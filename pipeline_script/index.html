<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Pipeline: a minimal example - Polgraw Group</title>

        <link href="../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">Polgraw Group</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">Home</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Pipeline description <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../input_data/">Input data generation</a>
                        </li>
                    
                        <li >
                            <a href="../search_for_candidates/">F-statistic candidate signal search</a>
                        </li>
                    
                        <li >
                            <a href="../coincidences/">Coincidences between candidates</a>
                        </li>
                    
                        <li >
                            <a href="../fap_coincidences/">False alarm probablity of conicidences</a>
                        </li>
                    
                        <li class="active">
                            <a href="./">Pipeline: a minimal example</a>
                        </li>
                    
                        <li >
                            <a href="../articles/">Documents and publications</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li >
                    <a rel="next" href="../fap_coincidences/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../articles/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#pipeline-a-minimal-example">Pipeline: a minimal example</a></li>
        
            <li><a href="#1-sample-pbstorque-script">1. Sample PBS/Torque script</a></li>
        
            <li><a href="#2-sample-pbstorque-script-using-the-c-coincidences-code">2. Sample PBS/Torque script using the C coincidences code</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="pipeline-a-minimal-example">Pipeline: a minimal example</h1>
<h3 id="1-sample-pbstorque-script">1. Sample PBS/Torque script</h3>
<p>This is a sample <code>pipeline.sh</code> script for the spotlight version of the <code>search</code> code, designed to look for signal around a specific location given by the spotlight range data file for 2-day narrow-band data segments. After the candidate signals are found, the search for coincidences is performed. It is currently used in the Mock Data Challenge with injected signals.  </p>
<p>This script uses a lower threshold (option <code>-t 10</code>) while searching for candidate signals, looks for coincidences in a <code>[4 4 4 4]</code> cell (see options to <code>coiproc</code>) and prepares the summary of the estimation (<code>summary</code> file) at the end of execution. The binary files <code>*.coi</code> - results of coincidences - are archived with the <code>lz4.gz</code> (<a href="https://code.google.com/p/lz4">lz4</a>) compression to save space, and deleted after the coincidences procedure is done.  </p>
<div class="codehilite"><pre><span></span><span class="ch">#!/bin/bash </span>
<span class="c1">#PBS -m n </span>
<span class="c1">#PBS -j oe</span>
<span class="c1">#PBS -q medium</span>
<span class="c1">#PBS -l walltime=48:00:00</span>

<span class="c1"># Data directory </span>
<span class="nv">data</span><span class="o">=</span>/work/psk/bejger/mdc/pulsar-data
<span class="c1"># Candidate (triggers) files output directory </span>
<span class="nv">candout</span><span class="o">=</span>/work/psk/bejger/mdc/cand-mdcthr10_<span class="nv">$FILENUM</span>

<span class="c1"># Directory with coincidence codes </span>
<span class="nv">coisrc</span><span class="o">=</span>/work/psk/bejger/mdc/coincidences-codes-binary
<span class="c1"># Coincidences output directory </span>
<span class="nv">coiout</span><span class="o">=</span>/work/psk/bejger/mdc/coin-mdcthr10_<span class="nv">$FILENUM</span>

<span class="c1"># Path to the libraries (in the src/lib directory of the search code)</span>
<span class="nv">ldlp</span><span class="o">=</span>/work/psk/bejger/mdc/spotlight/src/lib/yeppp-1.0.0/binaries/linux/x86_64

<span class="c1"># Path to lz4 compressor</span>
<span class="nv">lz4path</span><span class="o">=</span>/work/psk/bejger/codes/lz4-r131/programs

<span class="nb">cd</span> <span class="nv">$PBS_O_WORKDIR</span>

<span class="k">while</span> <span class="nb">read</span> line<span class="p">;</span> <span class="k">do</span>

  <span class="c1"># pulsar name and frequency, and band frequency (from pulsar_file_$FILENUM)</span>
  <span class="c1"># the master file is mdc_1561pulsars (name fpo f_gw) </span>
  <span class="nv">name</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$line</span> <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
  <span class="nv">fgw</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$line</span> <span class="p">|</span> awk <span class="s1">&#39;{print $3}&#39;</span><span class="k">)</span>
  <span class="nv">fpo</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$line</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>

  <span class="c1">#-----------------------</span>
  <span class="c1"># Search for candidates </span>
  <span class="c1">#-----------------------</span>
  <span class="nb">echo</span> <span class="nv">$name</span> <span class="k">$(</span>date +%H:%M:%S<span class="k">)</span> <span class="s2">&quot;candidate search&quot;</span> &gt;&gt; <span class="nv">$PBS_O_WORKDIR</span>/timing_<span class="nv">$FILENUM</span>

  <span class="c1"># search in frames xxx -- yyy  </span>
  <span class="k">for</span> i in <span class="k">$(</span>seq -f %03g <span class="m">1</span> 210<span class="k">)</span><span class="p">;</span> <span class="k">do</span>

    <span class="c1"># spotlight file range location </span>
    <span class="nv">spoth1</span><span class="o">=</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span>/<span class="si">${</span><span class="nv">i</span><span class="si">}</span>/H1/spot_<span class="si">${</span><span class="nv">name</span><span class="si">}</span>.dat
    <span class="nv">spotl1</span><span class="o">=</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span>/<span class="si">${</span><span class="nv">i</span><span class="si">}</span>/L1/spot_<span class="si">${</span><span class="nv">name</span><span class="si">}</span>.dat

    <span class="c1"># Here we assume that both H1 and L1 data is present for segment $i, </span>
    <span class="c1"># and take the H1 spotlight file to analyze it. If $spoth1 is not present, </span>
    <span class="c1"># it means there is no good H1 data. We then try $spotl1 as the spotlight file.  </span>
    <span class="c1"># If both $spoth1 and $spotl1 are missing, it means there is no good data </span>
    <span class="c1"># and the code exits (since there is nothing to analyze).</span>

    <span class="nv">spotfile</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$spoth1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nv">spotfile</span><span class="o">=</span><span class="nv">$spoth1</span> 
    <span class="k">else</span> <span class="nv">spotfile</span><span class="o">=</span><span class="nv">$spotl1</span>
    <span class="k">fi</span> 

    <span class="c1"># threshold is set to -threshold 10</span>
    <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$ldlp</span> ./search -data <span class="nv">$data</span> -ident <span class="nv">$i</span> -band <span class="m">000</span> --nocheckpoint -output <span class="nv">$candout</span> -spotlight <span class="nv">$spotfile</span> -fpo <span class="nv">$fpo</span> -label <span class="nv">$name</span> -dt <span class="m">2</span> -threshold <span class="m">10</span> 1&gt;&gt; <span class="nv">$name</span>.<span class="nv">$PBS_JOBID</span>.out 2&gt;&gt; <span class="nv">$name</span>.<span class="nv">$PBS_JOBID</span>.err

  <span class="k">done</span> 

  <span class="c1">#------------------------------------------ </span>
  <span class="c1"># Search for coincidences among candidates </span>
  <span class="c1">#------------------------------------------</span>
  <span class="nb">echo</span> <span class="nv">$name</span> <span class="k">$(</span>date +%H:%M:%S<span class="k">)</span> <span class="s2">&quot;coincidences&quot;</span> &gt;&gt; <span class="nv">$PBS_O_WORKDIR</span>/timing_<span class="nv">$FILENUM</span>


  mkdir -p <span class="nv">$coiout</span>/<span class="nv">$name</span><span class="p">;</span> <span class="nb">cd</span> <span class="nv">$coiout</span>/<span class="nv">$name</span>

  <span class="c1"># Copying the trigger files to the working directory </span>
  cp <span class="nv">$candout</span>/triggers*<span class="si">${</span><span class="nv">name</span><span class="si">}</span>*.bin .

  <span class="c1"># Name for the list of files </span>
  <span class="nv">st</span><span class="o">=</span><span class="k">$(</span>ls triggers*<span class="si">${</span><span class="nv">name</span><span class="si">}</span>*.bin <span class="p">|</span> tail -1<span class="k">)</span><span class="p">;</span> <span class="nv">listfile</span><span class="o">=</span><span class="si">${</span><span class="nv">st</span><span class="p">: -16:</span><span class="nv">10</span><span class="si">}</span><span class="s1">&#39;_000&#39;</span><span class="si">${</span><span class="nv">st</span><span class="p">: -6:</span><span class="nv">2</span><span class="si">}</span><span class="s1">&#39;.list&#39;</span><span class="p">;</span>
  <span class="nb">echo</span> <span class="s2">&quot;Name for the list of files: &quot;</span> <span class="nv">$listfile</span> 

  <span class="nb">echo</span> <span class="s2">&quot;Removing the name of the pulsar from the triggers&#39; files...&quot;</span>
  <span class="k">for</span> f in <span class="k">$(</span>ls triggers_*.bin<span class="k">)</span><span class="p">;</span> <span class="k">do</span> mv <span class="nv">$f</span> <span class="si">${</span><span class="nv">f</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">16</span><span class="si">}${</span><span class="nv">f</span><span class="p">: -6:</span><span class="nv">6</span><span class="si">}</span><span class="p">;</span> <span class="k">done</span>

  <span class="nb">echo</span> <span class="s2">&quot;Vetoing: processing the triggers&#39; files...&quot;</span> 
  <span class="k">for</span> f in <span class="k">$(</span>ls triggers_*.bin<span class="k">)</span><span class="p">;</span> <span class="k">do</span> 
    <span class="nv">$coisrc</span>/trigveto -noveto -fpo <span class="nv">$fpo</span> <span class="nv">$f</span>  
    <span class="c1"># Removing original triggers files </span>
    rm <span class="nv">$f</span> 
  <span class="k">done</span> 

  <span class="nb">echo</span> <span class="s2">&quot;Removing candidates outside a narrow frequency band (+- 0.05)...&quot;</span>
  <span class="k">for</span> f in <span class="k">$(</span>ls pvc_*.bin<span class="k">)</span><span class="p">;</span> <span class="k">do</span>
    <span class="nv">$coisrc</span>/decym <span class="nv">$f</span> <span class="nv">$fgw</span> 0.05
  <span class="k">done</span>

  <span class="nb">echo</span> <span class="s2">&quot;Writing list of pvc files to &quot;</span> <span class="nv">$listfile</span> 
  ls pvc_*.bin &gt; <span class="nv">$listfile</span>

  <span class="nb">echo</span> <span class="s2">&quot;Searching for coincidences...&quot;</span> 
  <span class="k">for</span> i in <span class="o">{</span>0..1<span class="o">}{</span>0..1<span class="o">}{</span>0..1<span class="o">}{</span>0..1<span class="o">}</span><span class="p">;</span> <span class="k">do</span> 
    <span class="nv">$coisrc</span>/coiproc -binary -refr <span class="m">100</span> -scale_f <span class="m">4</span> -scale_s <span class="m">4</span> -scale_a <span class="m">4</span> -scale_d <span class="m">4</span> -shift <span class="nv">$i</span> -fpo <span class="nv">$fpo</span> <span class="nv">$listfile</span> 
  <span class="k">done</span>

  <span class="nb">echo</span> <span class="s2">&quot;Generating the stat file...&quot;</span> 
  <span class="nv">st</span><span class="o">=</span><span class="k">$(</span>grep <span class="s2">&quot;Max value&quot;</span> *.resf <span class="p">|</span> sort -gk <span class="m">5</span> <span class="p">|</span> tail -1<span class="k">)</span>
  <span class="nv">mcoi</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$st</span> <span class="p">|</span> awk <span class="s1">&#39;{print $5}&#39;</span><span class="k">)</span>
  <span class="nv">resf</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$st</span> <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
  <span class="nv">resf</span><span class="o">=</span><span class="si">${</span><span class="nv">resf</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">10</span><span class="si">}</span> 
  <span class="nv">$coisrc</span>/resf2stat -threshold <span class="nv">$mcoi</span> -binary <span class="nv">$resf</span> 

  <span class="nb">echo</span> <span class="s2">&quot;Estimating the parameters...&quot;</span>
  <span class="nv">$coisrc</span>/stat2data -threshold <span class="nv">$mcoi</span> -refr <span class="m">100</span> . *.stat

  <span class="nb">echo</span> <span class="s2">&quot;Preparing the summary...&quot;</span> 
  <span class="nv">st</span><span class="o">=</span><span class="k">$(</span>find . -name <span class="s2">&quot;*.stat.dat&quot;</span> -printf <span class="s1">&#39;%f\n&#39;</span><span class="k">)</span>
  <span class="k">if</span> <span class="o">[</span> -z <span class="nv">$st</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="nv">$name</span> <span class="nv">$fpo</span> <span class="s2">&quot;no coincidences&quot;</span> &gt;&gt; ../summary
  <span class="k">else</span>
    <span class="nb">echo</span> <span class="nv">$name</span> <span class="nv">$fpo</span> <span class="k">$(</span>wc -l &lt; <span class="nv">$listfile</span><span class="k">)</span> <span class="k">$(</span>awk <span class="s1">&#39;END{printf &quot;%20s %.9e %.9e %.9e %.9e %.9e&quot;,FILENAME,$3,$4,$5,$6,$7}&#39;</span> <span class="nv">$st</span><span class="k">)</span> &gt;&gt; ../summary
  <span class="k">fi</span> 

  <span class="c1"># Cleanup (archiving and deleting the coi files) </span>
  <span class="nb">echo</span> <span class="nv">$name</span> <span class="k">$(</span>date +%H:%M:%S<span class="k">)</span> <span class="s2">&quot;archiving coi files&quot;</span> &gt;&gt; <span class="nv">$PBS_O_WORKDIR</span>/timing_<span class="nv">$FILENUM</span>

  <span class="k">for</span> r in <span class="k">$(</span>ls *.coi<span class="k">)</span><span class="p">;</span> <span class="k">do</span> 
    <span class="si">${</span><span class="nv">lz4path</span><span class="si">}</span>/lz4 -6 <span class="si">${</span><span class="nv">r</span><span class="si">}</span> <span class="si">${</span><span class="nv">r</span><span class="si">}</span>.lz4 <span class="o">&amp;&amp;</span> gzip <span class="si">${</span><span class="nv">r</span><span class="si">}</span>.lz4
    <span class="k">if</span> <span class="o">[</span> -f <span class="si">${</span><span class="nv">r</span><span class="si">}</span><span class="s2">&quot;.lz4.gz&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> 
      rm <span class="nv">$r</span>
    <span class="k">fi</span> 
  <span class="k">done</span> 

  <span class="nb">cd</span> <span class="nv">$PBS_O_WORKDIR</span>

  <span class="nb">echo</span> <span class="nv">$name</span> <span class="k">$(</span>date +%H:%M:%S<span class="k">)</span> <span class="s2">&quot;end&quot;</span> &gt;&gt; <span class="nv">$PBS_O_WORKDIR</span>/timing_<span class="nv">$FILENUM</span>

<span class="k">done</span> &lt; pulsar_file_<span class="nv">$FILENUM</span>

<span class="nb">exit</span> 0
</pre></div>


<p>where the <code>pulsar_file_$FILENUM</code> contains 3 columns: pulsar <code>name</code>, <code>fpo</code> reference frequency and gravitational wave frequency of the pulsar <code>fgw</code>. For an exemplary <code>pulsar_file_666</code>, contaning 8 pulsars,  </p>
<div class="codehilite"><pre><span></span>J0440+6416 516.601562 516.721000
J0714-6355 538.630859 538.755400
J0424+3800 561.185547 561.302200
J0303-5616 1089.595703 1089.719400
J0612+3324 390.177734 390.297600
J0319-7629 466.138672 466.263800
J0803-6214 1700.154297 1700.281800
J0534+0935 258.660156 258.781000
</pre></div>


<p>the job can be sent to the PBS queue in the following way:  </p>
<div class="codehilite"><pre><span></span>qsub -v FILENUM=666 -N mdc-666 pipeline.sh
</pre></div>


<h3 id="2-sample-pbstorque-script-using-the-c-coincidences-code">2. Sample PBS/Torque script using the <code>C</code> coincidences code</h3>
<div class="codehilite"><pre><span></span><span class="ch">#!/bin/bash </span>
<span class="c1">#PBS -m n </span>
<span class="c1">#PBS -j oe</span>
<span class="c1">#PBS -q medium</span>
<span class="c1">#PBS -l mem=2GB</span>
<span class="c1">#PBS -l walltime=04:00:00</span>

<span class="c1"># Data directory </span>
<span class="nv">data</span><span class="o">=</span>/work/psk/bejger/mdc/pulsar-data
<span class="c1"># Candidate (triggers) files output directory </span>
<span class="nv">candout</span><span class="o">=</span>/work/psk/bejger/mdc/candidates-mdc-thr10

<span class="c1"># Directory with coincidence codes </span>
<span class="nv">coisrc</span><span class="o">=</span>/work/psk/bejger/mdc/ccoin
<span class="c1"># Coincidences output directory </span>
<span class="nv">coiout</span><span class="o">=</span>/work/psk/bejger/mdc/coin-mdcthr10

<span class="c1"># Path to the libraries (in the src/lib directory of the search code)</span>
<span class="nv">ldlp</span><span class="o">=</span>/work/psk/bejger/mdc/spotlight/src/lib/yeppp-1.0.0/binaries/linux/x86_64

<span class="c1"># Path to lz4 compressor</span>
<span class="nv">lz4path</span><span class="o">=</span>/work/psk/bejger/codes/lz4-r131/programs

<span class="nb">cd</span> <span class="nv">$PBS_O_WORKDIR</span>

<span class="k">while</span> <span class="nb">read</span> line<span class="p">;</span> <span class="k">do</span>

  <span class="c1"># pulsar name and frequency, and band frequency (from pulsar_file_$FILENUM)</span>
  <span class="c1"># the master file is mdc_1561pulsars (name fpo f_gw) </span>
  <span class="nv">name</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$line</span> <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
  <span class="nv">fgw</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$line</span> <span class="p">|</span> awk <span class="s1">&#39;{print $3}&#39;</span><span class="k">)</span>
  <span class="nv">fpo</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$line</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>

  <span class="c1">#-----------------------</span>
  <span class="c1"># Search for candidates </span>
  <span class="c1">#-----------------------</span>
  <span class="nb">echo</span> <span class="nv">$name</span> <span class="k">$(</span>date +%H:%M:%S<span class="k">)</span> <span class="s2">&quot;candidate search&quot;</span> &gt;&gt; <span class="nv">$PBS_O_WORKDIR</span>/timing_<span class="nv">$FILENUM</span>

  <span class="c1"># search in frames xxx -- yyy  </span>
  <span class="k">for</span> i in <span class="k">$(</span>seq -f %03g <span class="m">1</span> 210<span class="k">)</span><span class="p">;</span> <span class="k">do</span>

    <span class="c1"># spotlight file range location </span>
    <span class="nv">spoth1</span><span class="o">=</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span>/<span class="si">${</span><span class="nv">i</span><span class="si">}</span>/H1/spot_<span class="si">${</span><span class="nv">name</span><span class="si">}</span>.dat
    <span class="nv">spotl1</span><span class="o">=</span><span class="si">${</span><span class="nv">data</span><span class="si">}</span>/<span class="si">${</span><span class="nv">i</span><span class="si">}</span>/L1/spot_<span class="si">${</span><span class="nv">name</span><span class="si">}</span>.dat

    <span class="c1"># Here we assume that both H1 and L1 data is present for segment $i, </span>
    <span class="c1"># and take the H1 spotlight file to analyze it. If $spoth1 is not present, </span>
    <span class="c1"># it means there is no good H1 data. We then try $spotl1 as the spotlight file.  </span>
    <span class="c1"># If both $spoth1 and $spotl1 are missing, it means there is no good data </span>
    <span class="c1"># and the code exits (since there is nothing to analyze).</span>

    <span class="nv">spotfile</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$spoth1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nv">spotfile</span><span class="o">=</span><span class="nv">$spoth1</span> 
    <span class="k">else</span> <span class="nv">spotfile</span><span class="o">=</span><span class="nv">$spotl1</span>
    <span class="k">fi</span> 

    <span class="c1"># threshold is set to -threshold 10</span>
    <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$ldlp</span> ./search -data <span class="nv">$data</span> -ident <span class="nv">$i</span> -band <span class="m">000</span> --nocheckpoint -output <span class="nv">$candout</span> -spotlight <span class="nv">$spotfile</span> -fpo <span class="nv">$fpo</span> -label <span class="nv">$name</span> -dt <span class="m">2</span> -threshold <span class="m">10</span> 1&gt;&gt; <span class="nv">$name</span>.<span class="nv">$PBS_JOBID</span>.out 2&gt;&gt; <span class="nv">$name</span>.<span class="nv">$PBS_JOBID</span>.err

  <span class="k">done</span> 

  <span class="c1">#------------------------------------------ </span>
  <span class="c1"># Search for coincidences among candidates </span>
  <span class="c1">#------------------------------------------</span>
  <span class="nb">echo</span> <span class="nv">$name</span> <span class="k">$(</span>date +%H:%M:%S<span class="k">)</span> <span class="s2">&quot;coinc: start&quot;</span> &gt;&gt; <span class="nv">$PBS_O_WORKDIR</span>/timing_<span class="nv">$FILENUM</span>

  <span class="c1"># Creating a directory for each pulsar coincidence files </span>
  mkdir -p <span class="nv">$coiout</span>/<span class="nv">$name</span>

  <span class="c1"># Searching for coincidences </span>
  <span class="k">for</span> shi in <span class="o">{</span>0..1<span class="o">}{</span>0..1<span class="o">}{</span>0..1<span class="o">}{</span>0..1<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
    ./coincidences -data <span class="nv">$candout</span> -trigname <span class="nv">$name</span> -refloc <span class="si">${</span><span class="nv">coisrc</span><span class="si">}</span>/coinc-testdata -fpo <span class="nv">$fpo</span> -shift <span class="nv">$shi</span> -scale <span class="m">4444</span> -refr <span class="m">100</span> -dt <span class="m">2</span> -mincoin <span class="m">15</span> -narrowdown 0.2 -output <span class="si">${</span><span class="nv">coiout</span><span class="si">}</span>/<span class="si">${</span><span class="nv">name</span><span class="si">}</span> 2&gt;&gt; <span class="si">${</span><span class="nv">coiout</span><span class="si">}</span>/<span class="si">${</span><span class="nv">name</span><span class="si">}</span>/summary 1&gt; /dev/null  
  <span class="k">done</span>

  <span class="c1"># Selecting maximal coincidence among all 16 shifts (col. 5) </span>
  <span class="c1"># If many, select the one with highest SNR (col. 10)  </span>
  sort -rgk5 -gk10 <span class="si">${</span><span class="nv">coiout</span><span class="si">}</span>/<span class="si">${</span><span class="nv">name</span><span class="si">}</span>/summary <span class="p">|</span> head -1 &gt;&gt; <span class="si">${</span><span class="nv">coiout</span><span class="si">}</span>/summary 

  <span class="c1">#------------------------------------------ </span>
  <span class="c1"># Cleanup </span>
  <span class="c1">#------------------------------------------</span>

  <span class="nb">echo</span> <span class="nv">$name</span> <span class="k">$(</span>date +%H:%M:%S<span class="k">)</span> <span class="s2">&quot;coinc: archiving coi files&quot;</span> &gt;&gt; <span class="nv">$PBS_O_WORKDIR</span>/timing_<span class="nv">$FILENUM</span>

  <span class="k">for</span> r in <span class="k">$(</span>ls <span class="si">${</span><span class="nv">coiout</span><span class="si">}</span>/<span class="si">${</span><span class="nv">name</span><span class="si">}</span>/*.coi<span class="k">)</span><span class="p">;</span> <span class="k">do</span> 
    <span class="si">${</span><span class="nv">lz4path</span><span class="si">}</span>/lz4 -6 <span class="si">${</span><span class="nv">r</span><span class="si">}</span> <span class="si">${</span><span class="nv">r</span><span class="si">}</span>.lz4 <span class="o">&amp;&amp;</span> gzip <span class="si">${</span><span class="nv">r</span><span class="si">}</span>.lz4
    <span class="k">if</span> <span class="o">[</span> -f <span class="si">${</span><span class="nv">r</span><span class="si">}</span><span class="s2">&quot;.lz4.gz&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> 
      rm <span class="nv">$r</span>
    <span class="k">fi</span> 
  <span class="k">done</span> 

  <span class="nb">echo</span> <span class="nv">$name</span> <span class="k">$(</span>date +%H:%M:%S<span class="k">)</span> <span class="s2">&quot;coinc: end&quot;</span> &gt;&gt; <span class="nv">$PBS_O_WORKDIR</span>/timing_<span class="nv">$FILENUM</span>

<span class="k">done</span> &lt; pulsar_file_<span class="nv">$FILENUM</span>

<span class="nb">exit</span> 0
</pre></div></div>
        </div>

	<footer class="col-md-12">
		<hr>
		
		<p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
	</footer>


        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/base.js"></script>
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
    </body>
</html>