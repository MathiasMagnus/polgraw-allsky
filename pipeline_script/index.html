<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Pipeline script - Polgraw Group</title>

        <link href="../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">Polgraw Group</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">Home</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Pipeline description <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../input_data/">Input data generation</a>
                        </li>
                    
                        <li >
                            <a href="../search_for_candidates/">Search for candidate signals</a>
                        </li>
                    
                        <li >
                            <a href="../coincidences/">Coincidences between candidates</a>
                        </li>
                    
                        <li class="active">
                            <a href="./">Pipeline script</a>
                        </li>
                    
                        <li >
                            <a href="../articles/">Literature</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li >
                    <a rel="next" href="../coincidences/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../articles/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#pipeline-search-for-candidate-signals-and-coincidences-among-them">Pipeline: search for candidate signals and coincidences among them</a></li>
        
            <li><a href="#1-sample-pbstorque-script">1. Sample PBS/Torque script</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="pipeline-search-for-candidate-signals-and-coincidences-among-them">Pipeline: search for candidate signals and coincidences among them</h1>
<h3 id="1-sample-pbstorque-script">1. Sample PBS/Torque script</h3>
<p>This is a sample <code>pipeline.sh</code> script for the spotlight version of the <code>search</code> code, designed to look for signal around a specific location given by the spotlight range data file for 2-day narrow-band data segments. After the candidate signals are found, the search for coincidences is performed. It is currently used in the Mock Data Challenge with injected signals.  </p>
<p>This script uses a lower threshold (option <code>-t 10</code>) while searching for candidate signals, looks for coincidences in a <code>[4 4 4 4]</code> cell (see options to <code>coiproc</code>) and prepares the summary of the estimation (<code>summary</code> file) at the end of execution. The binary files <code>*.coi</code> - results of coincidences - are archived with the <code>lz4.gz</code> (<a href="https://code.google.com/p/lz4">lz4</a>) compression to save space, and deleted after the coincidences procedure is done.  </p>
<pre><code class="bash">#!/bin/bash 
#PBS -m n 
#PBS -j oe
#PBS -q medium
#PBS -l walltime=48:00:00

# Data directory 
data=/work/psk/bejger/mdc/pulsar-data
# Candidate (triggers) files output directory 
candout=/work/psk/bejger/mdc/cand-mdcthr10_$FILENUM

# Directory with coincidence codes 
coisrc=/work/psk/bejger/mdc/coincidences-codes-binary
# Coincidences output directory 
coiout=/work/psk/bejger/mdc/coin-mdcthr10_$FILENUM

# Path to the libraries (in the src/lib directory of the search code)
ldlp=/work/psk/bejger/mdc/spotlight/src/lib/yeppp-1.0.0/binaries/linux/x86_64

# Path to lz4 compressor
lz4path=/work/psk/bejger/codes/lz4-r131/programs

cd $PBS_O_WORKDIR

while read line; do

  # pulsar name and frequency, and band frequency (from pulsar_file_$FILENUM)
  # the master file is mdc_1561pulsars (name fpo f_gw) 
  name=$(echo $line | awk '{print $1}')
  fgw=$(echo $line | awk '{print $3}')
  fpo=$(echo $line | awk '{print $2}')

  #-----------------------
  # Search for candidates 
  #-----------------------
  echo $name $(date +%H:%M:%S) &quot;candidate search&quot; &gt;&gt; $PBS_O_WORKDIR/timing_$FILENUM

  # search in frames xxx -- yyy  
  for i in $(seq -f %03g 1 210); do

    # spotlight file range location 
    spoth1=${data}/${i}/H1/spot_${name}.dat
    spotl1=${data}/${i}/L1/spot_${name}.dat

    # Here we assume that both H1 and L1 data is present for segment $i, 
    # and take the H1 spotlight file to analyze it. If $spoth1 is not present, 
    # it means there is no good H1 data. We then try $spotl1 as the spotlight file.  
    # If both $spoth1 and $spotl1 are missing, it means there is no good data 
    # and the code exits (since there is nothing to analyze).

    spotfile=''
    if [ -f $spoth1 ]; then spotfile=$spoth1 
    else spotfile=$spotl1
    fi 

    # threshold is set to -threshold 10
    LD_LIBRARY_PATH=$ldlp ./search -data $data -ident $i -band 000 --nocheckpoint -output $candout -spotlight $spotfile -fpo $fpo -label $name -dt 2 -threshold 10 1&gt;&gt; $name.$PBS_JOBID.out 2&gt;&gt; $name.$PBS_JOBID.err

  done 

  #------------------------------------------ 
  # Search for coincidences among candidates 
  #------------------------------------------
  echo $name $(date +%H:%M:%S) &quot;coincidences&quot; &gt;&gt; $PBS_O_WORKDIR/timing_$FILENUM


  mkdir -p $coiout/$name; cd $coiout/$name

  # Copying the trigger files to the working directory 
  cp $candout/triggers*${name}*.bin .

  # Name for the list of files 
  st=$(ls triggers*${name}*.bin | tail -1); listfile=${st: -16:10}'_000'${st: -6:2}'.list';
  echo &quot;Name for the list of files: &quot; $listfile 

  echo &quot;Removing the name of the pulsar from the triggers' files...&quot;
  for f in $(ls triggers_*.bin); do mv $f ${f:0:16}${f: -6:6}; done

  echo &quot;Vetoing: processing the triggers' files...&quot; 
  for f in $(ls triggers_*.bin); do 
    $coisrc/trigveto -noveto -fpo $fpo $f  
    # Removing original triggers files 
    rm $f 
  done 

  echo &quot;Removing candidates outside a narrow frequency band (+- 0.05)...&quot;
  for f in $(ls pvc_*.bin); do
    $coisrc/decym $f $fgw 0.05
  done

  echo &quot;Writing list of pvc files to &quot; $listfile 
  ls pvc_*.bin &gt; $listfile

  echo &quot;Searching for coincidences...&quot; 
  for i in {0..1}{0..1}{0..1}{0..1}; do 
    $coisrc/coiproc -binary -refr 100 -scale_f 4 -scale_s 4 -scale_a 4 -scale_d 4 -shift $i -fpo $fpo $listfile 
  done

  echo &quot;Generating the stat file...&quot; 
  st=$(grep &quot;Max value&quot; *.resf | sort -gk 5 | tail -1)
  mcoi=$(echo $st | awk '{print $5}')
  resf=$(echo $st | awk '{print $1}')
  resf=${resf:0:10} 
  $coisrc/resf2stat -threshold $mcoi -binary $resf 

  echo &quot;Estimating the parameters...&quot;
  $coisrc/stat2data -threshold $mcoi -refr 100 . *.stat

  echo &quot;Preparing the summary...&quot; 
  st=$(find . -name &quot;*.stat.dat&quot; -printf '%f\n')
  if [ -z $st ]; then
    echo $name $fpo &quot;no coincidences&quot; &gt;&gt; ../summary
  else
    echo $name $fpo $(wc -l &lt; $listfile) $(awk 'END{printf &quot;%20s %.9e %.9e %.9e %.9e %.9e&quot;,FILENAME,$3,$4,$5,$6,$7}' $st) &gt;&gt; ../summary
  fi 

  # Cleanup (archiving and deleting the coi files) 
  echo $name $(date +%H:%M:%S) &quot;archiving coi files&quot; &gt;&gt; $PBS_O_WORKDIR/timing_$FILENUM

  for r in $(ls *.coi); do 
    ${lz4path}/lz4 -6 ${r} ${r}.lz4 &amp;&amp; gzip ${r}.lz4
    if [ -f ${r}&quot;.lz4.gz&quot; ]; then 
      rm $r
    fi 
  done 

  cd $PBS_O_WORKDIR

  echo $name $(date +%H:%M:%S) &quot;end&quot; &gt;&gt; $PBS_O_WORKDIR/timing_$FILENUM

done &lt; pulsar_file_$FILENUM

exit 0
</code></pre>

<p>where the <code>pulsar_file_$FILENUM</code> contains 3 columns: pulsar <code>name</code>, <code>fpo</code> reference frequency and gravitational wave frequency of the pulsar <code>fgw</code>. For an exemplary <code>pulsar_file_666</code>, contaning 8 pulsars,  </p>
<pre><code>J0440+6416 516.601562 516.721000
J0714-6355 538.630859 538.755400
J0424+3800 561.185547 561.302200
J0303-5616 1089.595703 1089.719400
J0612+3324 390.177734 390.297600
J0319-7629 466.138672 466.263800
J0803-6214 1700.154297 1700.281800
J0534+0935 258.660156 258.781000
</code></pre>

<p>the job can be sent to the PBS queue in the following way:  </p>
<pre><code>qsub -v FILENUM=666 -N mdc-666 pipeline.sh
</code></pre></div>
        </div>

	<footer class="col-md-12">
		<hr>
		
		<center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
	</footer>


        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/base.js"></script>
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
        <script src="../js/mathjaxhelper.js"></script>
    </body>
</html>